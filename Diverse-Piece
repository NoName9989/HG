--// Services
local Players = game:GetService("Players")
local ReplicatedStorage = game:GetService("ReplicatedStorage")
local Lighting = game:GetService("Lighting")
local player = Players.LocalPlayer
local Character = player.Character or player.CharacterAdded:Wait()
local HRP = Character:WaitForChild("HumanoidRootPart")

--// Remotes
local InputFunc = ReplicatedStorage.Remotes.Functions.Input
local InputEvent = ReplicatedStorage.Remotes.Events.Input

--// NPC & Boss
local QuestNPC = workspace.NPCs["Quest Shinigami"]
local Enemies = workspace.Enemies
local BossName = "Shinigami [Level 1000]"

--// State
local Farm = false
local AutoM1 = false
local AutoHaki = false
local SelectedWeapons = {}
local backpackItems = {}
local ReduceLag = false
local BlackScreen = false

-- Store default lighting to restore later
local DefaultLighting = {
    Ambient = Lighting.Ambient,
    OutdoorAmbient = Lighting.OutdoorAmbient,
    GlobalShadows = Lighting.GlobalShadows
}

-- Update Character/HRP on respawn
player.CharacterAdded:Connect(function(char)
    Character = char
    HRP = char:WaitForChild("HumanoidRootPart")
end)

--// Follow boss function (-15 studs)
local function FollowBoss()
    local boss = Enemies:FindFirstChild(BossName)
    if boss and boss:FindFirstChild("HumanoidRootPart") then
        local br = boss.HumanoidRootPart
        local pos = br.Position + (br.CFrame.LookVector * -15) + Vector3.new(0,2,0)
        HRP.CFrame = CFrame.new(pos, br.Position)
    end
end

--// Equip selected weapon
local function EquipWeapon()
    for _, w in ipairs(SelectedWeapons) do
        local tool = player.Backpack:FindFirstChild(w)
        if tool then
            tool.Parent = workspace.Characters:FindFirstChild(player.Name)
            break
        end
    end
end

--// Refresh backpack items (manual)
local function RefreshBackpack()
    backpackItems = {}
    for _, item in ipairs(player.Backpack:GetChildren()) do
        if item:IsA("Tool") then
            table.insert(backpackItems, item.Name)
        end
    end
end

RefreshBackpack()

--// Check & Equip Haki nếu chưa bật
function CheckAndEquipHaki()
    local charFolder = workspace.Characters:FindFirstChild(player.Name)
    if charFolder and not charFolder:FindFirstChild("Armament Haki") then
        InputEvent:FireServer("Armament Haki")
    end
end

--// Main farm loop
task.spawn(function()
    while task.wait() do
        if Farm then
            pcall(function()
                local quests = player:WaitForChild("Data"):WaitForChild("Quests"):WaitForChild("Main")
                local questShinigami = quests:FindFirstChild("Quest Shinigami")

                if questShinigami then
                    local boss = Enemies:FindFirstChild(BossName)
                    if boss and boss:FindFirstChild("HumanoidRootPart") then
                        FollowBoss()
                        EquipWeapon()
                        if AutoHaki then CheckAndEquipHaki() end
                        local tool = Character:FindFirstChildWhichIsA("Tool")
                        if AutoM1 and tool then
                            InputEvent:FireServer("Tool", tool, "M1")
                        end
                    end
                else
                    HRP.CFrame = QuestNPC.HumanoidRootPart.CFrame * CFrame.new(0,2,0)
                    InputFunc:InvokeServer("Quest", "Accept", QuestNPC)
                    task.wait(0.2)
                end
            end)
        end
    end
end)

--// Auto Check & Equip Haki mỗi 3 giây
task.spawn(function()
    while task.wait(3) do
        if AutoHaki and Character then
            CheckAndEquipHaki()
        end
    end
end)

--// Lag reducer loop
local function RemoveEffects(model)
    for _, obj in ipairs(model:GetDescendants()) do
        if obj:IsA("ParticleEmitter") 
        or obj:IsA("Trail") 
        or obj:IsA("Beam") 
        or obj:IsA("Fire") 
        or obj:IsA("Smoke") then
            obj.Enabled = false
        end
    end
end

task.spawn(function()
    while task.wait(1) do
        if ReduceLag then
            if Character and Character:FindFirstChild("Humanoid") then
                local hum = Character.Humanoid
                for _, track in ipairs(hum:GetPlayingAnimationTracks()) do track:Stop() end
                if hum:FindFirstChild("Animator") then hum.Animator:Destroy() end
            end
            if Character then RemoveEffects(Character) end

            local boss = Enemies:FindFirstChild(BossName)
            if boss then
                if boss:FindFirstChild("Humanoid") then
                    for _, track in ipairs(boss.Humanoid:GetPlayingAnimationTracks()) do track:Stop() end
                end
                RemoveEffects(boss)
            end

            for _, obj in ipairs(workspace:GetDescendants()) do
                if obj:IsA("BillboardGui") or obj:IsA("SurfaceGui") then obj.Enabled = false
                elseif obj:IsA("PointLight") or obj:IsA("SpotLight") or obj:IsA("SurfaceLight") then obj.Enabled = false end
            end
        end
    end
end)

--// Black Screen Function (tăng size phủ toàn màn hình)
local function CreateBlackScreen()
    local playerGui = player:WaitForChild("PlayerGui")
    local gui = playerGui:FindFirstChild("BlackScreenGui")
    if gui then gui:Destroy() end

    gui = Instance.new("ScreenGui")
    gui.Name = "BlackScreenGui"
    gui.ResetOnSpawn = false
    gui.ZIndexBehavior = Enum.ZIndexBehavior.Sibling
    gui.Parent = playerGui

    local frame = Instance.new("Frame")
    frame.AnchorPoint = Vector2.new(0.5,0.5)
    frame.Position = UDim2.new(0.5, 0, 0.5, 0)
    frame.Size = UDim2.new(2, 0, 2, 0) -- phủ kín tuyệt đối
    frame.BackgroundColor3 = Color3.new(0,0,0)
    frame.BorderSizePixel = 0
    frame.ZIndex = 9999
    frame.Parent = gui

    return gui
end

-- Auto maintain BlackScreen
task.spawn(function()
    while task.wait(0.5) do
        if BlackScreen then
            if not player.PlayerGui:FindFirstChild("BlackScreenGui") then
                CreateBlackScreen()
            end
            Lighting.Ambient = Color3.new(0,0,0)
            Lighting.OutdoorAmbient = Color3.new(0,0,0)
            Lighting.GlobalShadows = false
        else
            local gui = player.PlayerGui:FindFirstChild("BlackScreenGui")
            if gui then gui:Destroy() end
            -- Restore default lighting
            Lighting.Ambient = DefaultLighting.Ambient
            Lighting.OutdoorAmbient = DefaultLighting.OutdoorAmbient
            Lighting.GlobalShadows = DefaultLighting.GlobalShadows
        end
    end
end)

--// Rayfield UI
local Rayfield = loadstring(game:HttpGet("https://sirius.menu/rayfield"))()

local Window = Rayfield:CreateWindow({
    Name = "Diverse Piece",
    LoadingTitle = "Loading...",
    LoadingSubtitle = "by HG",
    ConfigurationSaving = { Enabled = false },
    KeySystem = false
})

-- Tab 1: Shinigami Farm
local Tab1 = Window:CreateTab("Shinigami Farm")

Tab1:CreateToggle({
    Name = "Auto Farm Shinigami",
    CurrentValue = false,
    Callback = function(v) Farm = v end
})

Tab1:CreateToggle({
    Name = "Auto M1",
    CurrentValue = false,
    Callback = function(v) AutoM1 = v end
})

Tab1:CreateToggle({
    Name = "Auto Bật Haki",
    CurrentValue = false,
    Callback = function(v) AutoHaki = v end
})

local WeaponDrop = Tab1:CreateDropdown({
    Name = "Choose Weapons",
    Options = backpackItems,
    MultiSelect = true,
    Callback = function(opts) SelectedWeapons = opts end
})

Tab1:CreateButton({
    Name = "Refresh Weapons",
    Callback = function()
        RefreshBackpack()
        WeaponDrop:Refresh(backpackItems)
        SelectedWeapons = {}
    end
})

-- Tab 2: Performance / Lag Reducer + Black Screen
local Tab2 = Window:CreateTab("Performance / Lag Reducer")

Tab2:CreateToggle({
    Name = "Reduce Lag",
    CurrentValue = false,
    Callback = function(v) ReduceLag = v end
})

Tab2:CreateToggle({
    Name = "Black Screen",
    CurrentValue = false,
    Callback = function(v) BlackScreen = v end
})--// TAB 3: TELEPORT
local Tab3 = Window:CreateTab("Teleport")

local Players = game:GetService("Players")
local player = Players.LocalPlayer

local TeleportLocations = {
    ["Wani Kuni"] = CFrame.new(23.85, 156.91, -34.05),
    ["Starter"] = CFrame.new(-1330.14, 12.77, 1064.71),
    ["Namek"] = CFrame.new(-42.19, 11.34, 1366.13),
    ["Dadadan"] = CFrame.new(-1369.99, 11.94, 169.85),
    ["Scrapyard"] = CFrame.new(1474.92, 58.90, 943.75),
    ["Jujutsu"] = CFrame.new(-777.00, 13.94, -1225.88),
    ["Karakura"] = CFrame.new(1075.40, 19.25, -1156.35)
}

local SelectedTP = nil

Tab3:CreateDropdown({
    Name = "Chọn Map để Teleport",
    Options = (function()
        local list = {}
        for name,_ in pairs(TeleportLocations) do table.insert(list, name) end
        return list
    end)(),
    Callback = function(value)
        SelectedTP = TeleportLocations[value]
    end
})

Tab3:CreateButton({
    Name = "Teleport Map",
    Callback = function()
        if SelectedTP then
            local char = player.Character or player.CharacterAdded:Wait()
            local hrp = char:WaitForChild("HumanoidRootPart")
            hrp.CFrame = SelectedTP + Vector3.new(0,3,0)
        end
    end
})

----------------------------
-- TELEPORT NPC SECTION
----------------------------
local NPCList = {}
local npcFolder = workspace:FindFirstChild("NPCs") or workspace

for _, npc in ipairs(npcFolder:GetChildren()) do
    if npc:IsA("Model") or npc:IsA("Folder") then
        table.insert(NPCList, npc.Name)
    end
end

local SelectedNPC = nil

Tab3:CreateDropdown({
    Name = "Chọn NPC",
    Options = NPCList,
    Callback = function(v)
        SelectedNPC = v
    end
})

Tab3:CreateButton({
    Name = "Teleport NPC",
    Callback = function()
        if SelectedNPC then
            local npc = npcFolder:FindFirstChild(SelectedNPC)
            if npc then
                local char = player.Character or player.CharacterAdded:Wait()
                local hrp = char:WaitForChild("HumanoidRootPart")
                local root = npc:FindFirstChild("HumanoidRootPart") or npc:FindFirstChild("Head") or npc
                hrp.CFrame = root.CFrame + Vector3.new(0,3,0)
            end
        end
    end
})
